apiVersion: v1
data:
  LISTEN_PORT: "6432"
  MAX_CLIENT_CONN: "1000"
  PGBOUNCER_DEFAULT_POOL_SIZE: "200"
  PGBOUNCER_MAX_CLIENT_CONN: "5000"
  PGBOUNCER_POOL_MODE: transaction
  PGBOUNCER_RESERVE_POOL_SIZE: "100"
  POSTGRESQL_HOST: 10.48.0.2
kind: ConfigMap
metadata:
  annotations:
    app.tokko.io/env: prod
  labels:
    part-of: tokko-coupon
    product: tokko
  name: tokko-coupon-pgbouncer-bitnami
  namespace: tokko
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    app.tokko.io/env: prod
  labels:
    part-of: tokko-coupon
    product: tokko
  name: tokko-coupon-pgbouncer-bitnami
  namespace: tokko
spec:
  ports:
    - name: pgbouncer-bitnami
      port: 6432
      protocol: TCP
      targetPort: 6432
  selector:
    app: tokko-coupon-pgbouncer-bitnami
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    app.tokko.io/env: prod
  labels:
    app: tokko-coupon-pgbouncer-bitnami
    component: pgbouncer-bitnami
    part-of: tokko-coupon
    product: tokko
  name: tokko-coupon-pgbouncer-bitnami
  namespace: tokko
spec:
  replicas: 2
  selector:
    matchLabels:
      app: tokko-coupon-pgbouncer-bitnami
  strategy:
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 0
  template:
    metadata:
      annotations:
        app.tokko.io/env: prod
      labels:
        app: tokko-coupon-pgbouncer-bitnami
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - tokko-coupon-pgbouncer-bitnami
              topologyKey: kubernetes.io/hostname
      containers:
        - env:
            - name: POSTGRESQL_USERNAME
              value: $(DB_USER)
            - name: POSTGRESQL_PASSWORD
              value: $(DB_PASSWORD)
            - name: POSTGRESQL_DATABASE
              value: $(DB_NAME)
            - name: PGBOUNCER_DATABASE
              value: $(DB_NAME)
            - name: POSTGRESQL_PORT
              value: "5432"
            - name: ENABLE_APM_TRACING
              value: "true"
            - name: DD_AGENT_HOST
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: DD_VERSION
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['app.tokko.io/version']
            - name: DD_ENV
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['app.tokko.io/env']
            - name: SERVICE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['app']
          envFrom:
            - configMapRef:
                name: tokko-coupon
            - secretRef:
                name: tokko-coupon
            - configMapRef:
                name: tokko-coupon-pgbouncer-bitnami
          image: gcr.io/beecash-prod/pgbouncer:bitnami-1.17.0-debian-11-r7
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - sleep 15 && psql $PGBOUNCER_DB_ADMIN_URL -c "PAUSE $DB_NAME;"
          livenessProbe:
            initialDelaySeconds: 60
            periodSeconds: 10
            tcpSocket:
              port: 6432
          name: tokko-coupon-pgbouncer-bitnami
          readinessProbe:
            failureThreshold: 6
            initialDelaySeconds: 20
            periodSeconds: 10
            tcpSocket:
              port: 6432
          resources:
            limits:
              cpu: 1
              memory: 500Mi
            requests:
              cpu: 50m
              memory: 100Mi
        - env:
            - name: PGBOUNCER_USER
              valueFrom:
                configMapKeyRef:
                  key: DB_USER
                  name: tokko-coupon
            - name: PGBOUNCER_PASS
              valueFrom:
                secretKeyRef:
                  key: DB_PASSWORD
                  name: tokko-coupon
            - name: PGBOUNCER_EXPORTER_HOST
              value: 0.0.0.0
            - name: PGBOUNCER_PORT
              value: "6432"
          image: spreaker/prometheus-pgbouncer-exporter:2.1.1
          name: prometheus-pgbouncer-exporter
          ports:
            - containerPort: 9127
              name: pgb-metrics
          resources:
            limits:
              cpu: 100m
              memory: 500Mi
            requests:
              cpu: 10m
              memory: 50Mi
---
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  annotations:
    app.tokko.io/env: prod
  labels:
    part-of: tokko-coupon
    product: tokko
  name: tokko-coupon-pgbouncer-bitnami
  namespace: tokko
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: tokko-coupon-pgbouncer-bitnami
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  annotations:
    app.tokko.io/env: prod
  labels:
    part-of: tokko-coupon
    product: tokko
  name: tokko-coupon-pgbouncer-bitnami
  namespace: tokko
spec:
  podMetricsEndpoints:
    - honorLabels: true
      path: /pgbouncer-metrics
      port: pgb-metrics
  selector:
    matchLabels:
      app: tokko-coupon-pgbouncer-bitnami
